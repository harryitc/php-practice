<?php

/**
 * Script thi·∫øt l·∫≠p ho√†n ch·ªânh c∆° s·ªü d·ªØ li·ªáu
 * 
 * Script n√†y s·∫Ω:
 * 1. Ch·∫°y t·∫•t c·∫£ migration c∆° b·∫£n
 * 2. Th√™m d·ªØ li·ªáu m·∫´u ti·∫øng Vi·ªát
 * 3. Ki·ªÉm tra v√† b√°o c√°o k·∫øt qu·∫£
 */

// Set content type ƒë·ªÉ hi·ªÉn th·ªã ti·∫øng Vi·ªát ƒë√∫ng
header('Content-Type: text/html; charset=UTF-8');

// Load required files
require_once 'app/core/Database.php';
require_once 'app/core/Migration.php';

echo "<!DOCTYPE html>\n";
echo "<html lang='vi'>\n";
echo "<head>\n";
echo "    <meta charset='UTF-8'>\n";
echo "    <meta name='viewport' content='width=device-width, initial-scale=1.0'>\n";
echo "    <title>Thi·∫øt L·∫≠p Ho√†n Ch·ªânh C∆° S·ªü D·ªØ Li·ªáu</title>\n";
echo "    <style>\n";
echo "        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }\n";
echo "        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }\n";
echo "        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }\n";
echo "        .content { padding: 30px; }\n";
echo "        h1 { margin: 0; font-size: 2.5em; font-weight: 300; }\n";
echo "        .subtitle { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1em; }\n";
echo "        .success { color: #155724; background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745; }\n";
echo "        .error { color: #721c24; background: #f8d7da; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #dc3545; }\n";
echo "        .info { color: #0c5460; background: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #17a2b8; }\n";
echo "        .warning { color: #856404; background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107; }\n";
echo "        .step { margin: 20px 0; padding: 20px; border-radius: 10px; background: #f8f9fa; border: 1px solid #e9ecef; }\n";
echo "        .step h3 { margin-top: 0; color: #495057; }\n";
echo "        .progress { background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 15px 0; }\n";
echo "        .progress-bar { background: linear-gradient(90deg, #28a745, #20c997); height: 20px; transition: width 0.3s ease; }\n";
echo "        .links { margin-top: 30px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; }\n";
echo "        .links a { display: inline-block; margin: 5px 10px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 25px; transition: transform 0.2s ease; }\n";
echo "        .links a:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }\n";
echo "        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }\n";
echo "        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n";
echo "        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; }\n";
echo "        .stat-label { color: #6c757d; margin-top: 5px; }\n";
echo "    </style>\n";
echo "</head>\n";
echo "<body>\n";

echo "<div class='container'>\n";
echo "<div class='header'>\n";
echo "<h1>üöÄ Thi·∫øt L·∫≠p E-commerce</h1>\n";
echo "<p class='subtitle'>C∆° s·ªü d·ªØ li·ªáu ho√†n ch·ªânh v·ªõi d·ªØ li·ªáu m·∫´u ti·∫øng Vi·ªát</p>\n";
echo "</div>\n";

echo "<div class='content'>\n";

$totalSteps = 4;
$currentStep = 0;

try {
    // Step 1: Database Connection
    $currentStep++;
    echo "<div class='step'>\n";
    echo "<h3>B∆∞·ªõc {$currentStep}/{$totalSteps}: üîå Ki·ªÉm tra k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu</h3>\n";
    echo "<div class='progress'><div class='progress-bar' style='width: " . ($currentStep/$totalSteps*100) . "%'></div></div>\n";
    
    $db = Database::getInstance();
    echo "<div class='success'>‚úì K·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu th√†nh c√¥ng</div>\n";
    echo "</div>\n";
    
    // Step 2: Run Basic Migrations
    $currentStep++;
    echo "<div class='step'>\n";
    echo "<h3>B∆∞·ªõc {$currentStep}/{$totalSteps}: üîß Ch·∫°y migration c∆° b·∫£n</h3>\n";
    echo "<div class='progress'><div class='progress-bar' style='width: " . ($currentStep/$totalSteps*100) . "%'></div></div>\n";
    
    $migration = new Migration();
    $appliedMigrations = $migration->applyMigrations();
    
    if (empty($appliedMigrations)) {
        echo "<div class='info'>‚ÑπÔ∏è T·∫•t c·∫£ migration c∆° b·∫£n ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng tr∆∞·ªõc ƒë√≥</div>\n";
    } else {
        echo "<div class='success'>‚úì ƒê√£ √°p d·ª•ng " . count($appliedMigrations) . " migration:</div>\n";
        foreach ($appliedMigrations as $migrationName) {
            echo "<div class='info'>‚Ä¢ {$migrationName}</div>\n";
        }
    }
    echo "</div>\n";
    
    // Step 3: Add Vietnamese Sample Data
    $currentStep++;
    echo "<div class='step'>\n";
    echo "<h3>B∆∞·ªõc {$currentStep}/{$totalSteps}: üáªüá≥ Th√™m d·ªØ li·ªáu m·∫´u ti·∫øng Vi·ªát</h3>\n";
    echo "<div class='progress'><div class='progress-bar' style='width: " . ($currentStep/$totalSteps*100) . "%'></div></div>\n";
    
    // Check if Vietnamese data already exists
    $existingCategories = $db->query("SELECT COUNT(*) as count FROM categories WHERE name LIKE '%ChƒÉm s√≥c%'")->fetch();
    
    if ($existingCategories['count'] > 0) {
        echo "<div class='warning'>‚ö†Ô∏è D·ªØ li·ªáu ti·∫øng Vi·ªát ƒë√£ t·ªìn t·∫°i. ƒêang c·∫≠p nh·∫≠t...</div>\n";
        
        // Clear existing Vietnamese data
        require_once 'app/migrations/m0011_sample_data_vietnamese.php';
        $vietnameseMigration = new M0011SampleDataVietnamese();
        $vietnameseMigration->down();
        echo "<div class='info'>üóëÔ∏è ƒê√£ x√≥a d·ªØ li·ªáu c≈©</div>\n";
    }
    
    // Add new Vietnamese data
    require_once 'app/migrations/m0011_sample_data_vietnamese.php';
    $vietnameseMigration = new M0011SampleDataVietnamese();
    $vietnameseMigration->up();
    
    echo "<div class='success'>‚úì ƒê√£ th√™m d·ªØ li·ªáu m·∫´u ti·∫øng Vi·ªát th√†nh c√¥ng!</div>\n";
    echo "</div>\n";
    
    // Step 4: Verification and Statistics
    $currentStep++;
    echo "<div class='step'>\n";
    echo "<h3>B∆∞·ªõc {$currentStep}/{$totalSteps}: üìä Ki·ªÉm tra v√† th·ªëng k√™</h3>\n";
    echo "<div class='progress'><div class='progress-bar' style='width: 100%'></div></div>\n";
    
    // Get statistics
    $stats = [];
    $stats['categories'] = $db->query("SELECT COUNT(*) as count FROM categories")->fetch()['count'];
    $stats['products'] = $db->query("SELECT COUNT(*) as count FROM products")->fetch()['count'];
    $stats['customers'] = $db->query("SELECT COUNT(*) as count FROM users WHERE role = 'customer'")->fetch()['count'];
    $stats['orders'] = $db->query("SELECT COUNT(*) as count FROM orders")->fetch()['count'];
    $stats['order_items'] = $db->query("SELECT COUNT(*) as count FROM order_items")->fetch()['count'];
    
    echo "<div class='stats'>\n";
    echo "<div class='stat-card'><div class='stat-number'>{$stats['categories']}</div><div class='stat-label'>Danh m·ª•c</div></div>\n";
    echo "<div class='stat-card'><div class='stat-number'>{$stats['products']}</div><div class='stat-label'>S·∫£n ph·∫©m</div></div>\n";
    echo "<div class='stat-card'><div class='stat-number'>{$stats['customers']}</div><div class='stat-label'>Kh√°ch h√†ng</div></div>\n";
    echo "<div class='stat-card'><div class='stat-number'>{$stats['orders']}</div><div class='stat-label'>ƒê∆°n h√†ng</div></div>\n";
    echo "</div>\n";
    
    echo "<div class='success'>‚úì C∆° s·ªü d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p ho√†n ch·ªânh!</div>\n";
    echo "</div>\n";
    
    // Sample Data Preview
    echo "<div class='step'>\n";
    echo "<h3>üéØ Xem tr∆∞·ªõc d·ªØ li·ªáu m·∫´u</h3>\n";
    
    // Sample products with images
    echo "<h4>üõçÔ∏è S·∫£n ph·∫©m n·ªïi b·∫≠t:</h4>\n";
    $featuredProducts = $db->query("SELECT name, price, image, description FROM products ORDER BY RAND() LIMIT 3")->fetchAll();
    foreach ($featuredProducts as $product) {
        $price = number_format($product['price'], 0, ',', '.') . ' VNƒê';
        echo "<div class='info'>\n";
        echo "<strong>{$product['name']}</strong> - <span style='color: #28a745; font-weight: bold;'>{$price}</span><br>\n";
        echo "<small>{$product['description']}</small><br>\n";
        if ($product['image']) {
            echo "<img src='{$product['image']}' alt='{$product['name']}' style='width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin-top: 5px;'>\n";
        }
        echo "</div>\n";
    }
    
    // Sample orders
    echo "<h4>üì¶ ƒê∆°n h√†ng m·∫´u:</h4>\n";
    $sampleOrders = $db->query("
        SELECT o.order_number, u.name, o.total_amount, o.status, o.shipping_city 
        FROM orders o 
        JOIN users u ON o.user_id = u.id 
        ORDER BY o.created_at DESC 
        LIMIT 3
    ")->fetchAll();
    
    foreach ($sampleOrders as $order) {
        $total = number_format($order['total_amount'], 0, ',', '.') . ' VNƒê';
        $statusColors = [
            'pending' => '#ffc107',
            'confirmed' => '#17a2b8',
            'processing' => '#fd7e14',
            'shipped' => '#6f42c1',
            'delivered' => '#28a745'
        ];
        $statusColor = $statusColors[$order['status']] ?? '#6c757d';
        
        echo "<div class='info'>\n";
        echo "<strong>#{$order['order_number']}</strong> - {$order['name']}<br>\n";
        echo "T·ªïng ti·ªÅn: <strong style='color: #28a745;'>{$total}</strong> | ";
        echo "Tr·∫°ng th√°i: <span style='color: {$statusColor}; font-weight: bold;'>" . ucfirst($order['status']) . "</span><br>\n";
        echo "Giao ƒë·∫øn: {$order['shipping_city']}\n";
        echo "</div>\n";
    }
    
    echo "</div>\n";
    
    // Success message with login info
    echo "<div class='success'>\n";
    echo "<h3>üéâ Thi·∫øt l·∫≠p ho√†n t·∫•t!</h3>\n";
    echo "<p>C∆° s·ªü d·ªØ li·ªáu e-commerce ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p ho√†n ch·ªânh v·ªõi d·ªØ li·ªáu m·∫´u ti·∫øng Vi·ªát.</p>\n";
    echo "<h4>üîë Th√¥ng tin ƒëƒÉng nh·∫≠p:</h4>\n";
    echo "<div style='background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;'>\n";
    echo "<strong>üë®‚Äçüíº Admin:</strong><br>\n";
    echo "Email: <code>admin@example.com</code><br>\n";
    echo "M·∫≠t kh·∫©u: <code>admin123</code><br><br>\n";
    echo "<strong>üë• Kh√°ch h√†ng m·∫´u:</strong><br>\n";
    echo "Email: <code>hoa.nguyen@vietnam.com</code> | M·∫≠t kh·∫©u: <code>123456</code><br>\n";
    echo "Email: <code>nam.tran@vietnam.com</code> | M·∫≠t kh·∫©u: <code>123456</code><br>\n";
    echo "Email: <code>mai.le@vietnam.com</code> | M·∫≠t kh·∫©u: <code>123456</code>\n";
    echo "</div>\n";
    echo "</div>\n";
    
} catch (Exception $e) {
    echo "<div class='error'>\n";
    echo "<h3>‚ùå L·ªói trong qu√° tr√¨nh thi·∫øt l·∫≠p</h3>\n";
    echo "<p><strong>Th√¥ng b√°o l·ªói:</strong> " . htmlspecialchars($e->getMessage()) . "</p>\n";
    echo "<p><strong>File:</strong> " . htmlspecialchars($e->getFile()) . "</p>\n";
    echo "<p><strong>D√≤ng:</strong> " . $e->getLine() . "</p>\n";
    echo "<details><summary>Chi ti·∫øt l·ªói</summary><pre>" . htmlspecialchars($e->getTraceAsString()) . "</pre></details>\n";
    echo "</div>\n";
}

echo "<div class='links'>\n";
echo "<a href='/'>üè† Trang ch·ªß</a>\n";
echo "<a href='/test_order_placement.php'>üß™ Test ƒë·∫∑t h√†ng</a>\n";
echo "<a href='/test_tracking.php'>üìç Test tracking</a>\n";
echo "<a href='/run-migrations.php'>üîß Migration</a>\n";
echo "</div>\n";

echo "</div>\n";
echo "</div>\n";
echo "</body>\n";
echo "</html>\n";
?>
